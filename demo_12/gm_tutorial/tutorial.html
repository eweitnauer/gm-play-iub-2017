<!doctype html>
<meta charset="utf-8">
<title>GM Tutorial</title>
<!-- jQuery library -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="https://graspablemath.com/shared/libs/gmath/gm-inject.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<link rel="stylesheet" href="tutorial.css"/>
<script src="tutorial-data.js"></script>

<body>
<div id="tutorial-container">
        <div id ="1" class="levelTutorial container">
            <div id='outer1' class="carousel slide" data-ride="carousel" data-interval="false">
                <ol class="carousel-indicators">
                  <!--<li data-target="#myCarousel" data-slide-to="0" class="active"></li>
                  <li data-target="#myCarousel" data-slide-to="1"></li>
                  <li data-target="#myCarousel" data-slide-to="2"></li>
                  <li data-target="#myCarousel" data-slide-to="3"></li>-->
                </ol>
                <div id='inner1' class="carousel-inner" role="listbox"></div>

                  <a class="left carousel-control" href="#outer1" role="button" data-slide="prev">
                    <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
                    <span class="sr-only">Previous</span>
                  </a>
                  <a class="right carousel-control" href="#outer1" role="button" data-slide="next">
                    <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
                    <span class="sr-only">Next</span>
                  </a>
            </div>
        </div>
        <div id ="2" class="levelTutorial container">
            <div id='outer2' class="carousel slide" data-ride="carousel" data-interval="false">
                <ol class="carousel-indicators">
                </ol>
                    <div id='inner2' class="carousel-inner" role="listbox"></div>

                  <a class="left carousel-control" href="#outer2" role="button" data-slide="prev">
                    <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
                    <span class="sr-only">Previous</span>
                  </a>
                  <a class="right carousel-control" href="#outer2" role="button" data-slide="next">
                    <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
                    <span class="sr-only">Next</span>
                  </a>
            </div>
        </div>
        <div id ="3" class="levelTutorial container">
            <div id='outer3' class="carousel slide" data-ride="carousel" data-interval="false">
                <ol class="carousel-indicators">
                </ol>
                    <div id='inner3' class="carousel-inner" role="listbox"></div>

                  <a class="left carousel-control" href="#outer3" role="button" data-slide="prev">
                    <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
                    <span class="sr-only">Previous</span>
                  </a>
                  <a class="right carousel-control" href="#outer3" role="button" data-slide="next">
                    <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
                    <span class="sr-only">Next</span>
                  </a>
            </div>
        </div>
        <div id ="4" class="levelTutorial container">
            <div id='outer4' class="carousel slide" data-ride="carousel" data-interval="false">
                <ol class="carousel-indicators">
                </ol>
                    <div id='inner4' class="carousel-inner" role="listbox"></div>

                  <a class="left carousel-control" href="#outer4" role="button" data-slide="prev">
                    <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
                    <span class="sr-only">Previous</span>
                  </a>
                  <a class="right carousel-control" href="#outer4" role="button" data-slide="next">
                    <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
                    <span class="sr-only">Next</span>
                  </a>
            </div>
        </div>
        <div id ="5" class="levelTutorial container">
            <div id='outer5' class="carousel slide" data-ride="carousel" data-interval="false">
                <ol class="carousel-indicators">
                </ol>
                    <div id='inner5' class="carousel-inner" role="listbox"></div>

                  <a class="left carousel-control" href="#outer5" role="button" data-slide="prev">
                    <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
                    <span class="sr-only">Previous</span>
                  </a>
                  <a class="right carousel-control" href="#outer5" role="button" data-slide="next">
                    <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
                    <span class="sr-only">Next</span>
                  </a>
            </div>
        </div>
        <div id ="6" class="levelTutorial container">
            <div id='outer6' class="carousel slide" data-ride="carousel" data-interval="false">
                <ol class="carousel-indicators">
                </ol>
                    <div id='inner6' class="carousel-inner" role="listbox"></div>

                  <a class="left carousel-control" href="#outer6" role="button" data-slide="prev">
                    <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
                    <span class="sr-only">Previous</span>
                  </a>
                  <a class="right carousel-control" href="#outer6" role="button" data-slide="next">
                    <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
                    <span class="sr-only">Next</span>
                  </a>
            </div>
        </div>
        <div id ="7" class="levelTutorial container">
            <div id='outer7' class="carousel slide" data-ride="carousel" data-interval="false">
                <ol class="carousel-indicators">
                </ol>
                    <div id='inner7' class="carousel-inner" role="listbox"></div>

                  <a class="left carousel-control" href="#outer7" role="button" data-slide="prev">
                    <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
                    <span class="sr-only">Previous</span>
                  </a>
                  <a class="right carousel-control" href="#outer7" role="button" data-slide="next">
                    <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
                    <span class="sr-only">Next</span>
                  </a>
            </div>
        </div>
        <div id ="8" class="levelTutorial container">
            <div id='outer8' class="carousel slide" data-ride="carousel" data-interval="false">
                <ol class="carousel-indicators">
                </ol>
                    <div id='inner8' class="carousel-inner" role="listbox"></div>

                  <a class="left carousel-control" href="#outer8" role="button" data-slide="prev">
                    <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
                    <span class="sr-only">Previous</span>
                  </a>
                  <a class="right carousel-control" href="#outer8" role="button" data-slide="next">
                    <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
                    <span class="sr-only">Next</span>
                  </a>
            </div>
        </div>
        <div id ="9" class="levelTutorial container">
            <div id='outer9' class="carousel slide" data-ride="carousel" data-interval="false">
                <ol class="carousel-indicators">
                </ol>
                    <div id='inner9' class="carousel-inner" role="listbox"></div>

                  <a class="left carousel-control" href="#outer9" role="button" data-slide="prev">
                    <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
                    <span class="sr-only">Previous</span>
                  </a>
                  <a class="right carousel-control" href="#outer9" role="button" data-slide="next">
                    <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
                    <span class="sr-only">Next</span>
                  </a>
            </div>
        </div>
        <div id ="10" class="levelTutorial container">
            <div id='outer10' class="carousel slide" data-ride="carousel" data-interval="false">
                <ol class="carousel-indicators">
                </ol>
                    <div id='inner10' class="carousel-inner" role="listbox"></div>

                  <a class="left carousel-control" href="#outer10" role="button" data-slide="prev">
                    <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
                    <span class="sr-only">Previous</span>
                  </a>
                  <a class="right carousel-control" href="#outer10" role="button" data-slide="next">
                    <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
                    <span class="sr-only">Next</span>
                  </a>
            </div>
        </div>
</div>
<script>

window.onload = function () {
  loadGM(init, { version: '2.0.2' });
}
var g_done_count;
var g_counterInsideLevel = 0;

var derivation_container_size
  , pairs = [];
function fix_positions() {
  pairs.forEach(function(pair) {
    pair.dl.container_view = derivation_container_size;
    pair.player.dl.container_view = derivation_container_size;
    pair.dl.initPosition();
    pair.player.dl.initPosition();
  });
}

function init() {
	if (!tutorial_data) return;

    gmath.Derivation.defaultOptions.action_blacklist = ['FlipTermAcrossFractionAction',,'CombinationRewriteAction',
'EquationRewriteAction', 
'ExpressionRewriteAction',
'FirstLineRewriteAction',
'FractionRewriteAction',
'InequalityRewriteAction'];
    
	var tutorial_pairs = 0;
    g_done_count = 0;

    var totalLevels =10;
    for(var level = 1;level<=totalLevels;level++){
        if(tutorial_data[level]){
            g_counterInsideLevel = 0;
            for(var problemId in tutorial_data[level]){
                var problem =tutorial_data[level][problemId];
                load(problem,level);
            }
        }
    }

    setTimeout(fix_positions, 1000);

    function getRandomRange(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

	function load(data,level) {

		if (data.events) {
			/* Some repackaging of the data.
			*
			* In the tutorial-data file we set everything on the json events object itself, so now we'll make
			* the events object a property of our settings object.
			*
			* We also set the allow_restart_after_done option to be false, so each tutorial will be locked
			* once the user completes it.
			*/
			var settings = {
				gestureData: data
			, title: data.title
			, text: data.text
			, eq: data.user_eq || data.options.eq
			, correctAnswers: data.correctAnswers
			, startWiggle: data.startWiggle
			, allow_restart_after_done: true
			, log_mouse_trajectories: false
			};
			delete data.options.selection_color;

			// Pass in the query selector of the inner div to the tutorial pair, it will use that as the
			// container.
      var innerDiv = document.getElementById('inner'+level);
      //get the ol from innerdiv
      var x = innerDiv.previousSibling;
      //create new li for the ol
      var newLi = document.createElement('li');
      newLi.setAttribute("data-target","#outer"+level);
      newLi.setAttribute("data-slide-to",g_counterInsideLevel);
      if(g_counterInsideLevel==0)
          newLi.setAttribute("class", "active");
      //add li to ol

      var newItemDiv = document.createElement('div');

      var newItemDivId = 'item_div' + level + "_" + g_counterInsideLevel;
      newItemDiv.setAttribute("id", newItemDivId);
      if(g_counterInsideLevel==0)
          newItemDiv.setAttribute("class", "item active");
      else
          newItemDiv.setAttribute("class", "item");

      innerDiv.appendChild(newItemDiv);
      var pair = new gmath.ui.TutorialPair("#"+newItemDivId, settings);

      // The tutorial will emit a "done" event when the gesture has been done successfully.
      // We'll call our "done" function when that happens (defined below).
      pair.events.on('done', done.bind(this,level));

      // FIXING ISSUES W/ BOOTSTRAP CAROUSEL
      // The bootstrap carousel is tricky, because we're loading content into elements are not yet
      // rendered and have no dimensions. The first derivation will have the correct canvas size
      // settings, because the first item in the carousel is rendered.
      // Store those dimensions so we can apply them to the other derivations once everything is loaded.
      pairs.push(pair);
      if (!derivation_container_size) derivation_container_size = pair.dl.container_view;
      // Re-bind event listener on the svg of the replay once the svg is rendered. (Actually does this
      // for every tutorial pair right now, which it probably shouldn't).
      $(innerDiv.parentElement).on('slid.bs.carousel', function() {
        pair.play_btn.remove();
        pair.play_btn.init();
      });

			// We'll compare the number of done events with the number of pairs on the page.
			tutorial_pairs++;
            g_counterInsideLevel++;
		}

		else { // text only
			var el = document.getElementById('inner'+level);

			if (data.title) {
				var title = document.createElement('h2');
				var title_content = document.createTextNode(data.title);
				title.appendChild(title_content);
				el.appendChild(title);
			}

			if (data.text) {
				var instructions = document.createElement('p');
				instructions.className = 'tutorial-instructions';
				var instructions_content = document.createTextNode(data.text);
				instructions.appendChild(instructions_content);
				el.appendChild(instructions);
			}
		}
	}

	function done(level) {
		g_done_count++;
		if (g_done_count === tutorial_data[level].length) {
            window.parent.$("#tutorialModal").modal('hide');
		}
        else{
            //goto next slide
            $(".carousel").carousel('next');
        }
	}
}

</script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
